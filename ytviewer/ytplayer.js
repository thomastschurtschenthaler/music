!function(){function e(e,r,n,o){console.log("playNoMSE"),e.removeAttribute("src"),e.innerHTML="";let t=document.createElement("source");t.setAttribute("src",null!=o?o.url:r.audiovideo.url),t.setAttribute("type","video/mp4"),e.appendChild(t),e.load(),null!=n&&(e.currentTime=n),e.play()}function r(e,r,n,o,t,l,u,c){try{console.log("addSourceBuffer!!!");let i=r.addSourceBuffer(o),d={finished:!0,bussy:!1},s=null,a=!1,f={from:null,to:null,chunkSize:l,chunkCnt:u,remStart:!1,remEnd:!1};i.addEventListener("updateend",(function(e){if(console.log("updateend"),!a)try{if(null!=s&&(clearTimeout(s),s=null),d.finished){if(d.currentTime>20&&f.remStart&&i.buffered.end(0)>d.currentTime+20)return console.log("remove 1"),i.remove(0,d.currentTime-20),void(f.remStart=!1);if(f.remStart&&i.buffered.end(0)<d.currentTime&&i.buffered.end(0)-i.buffered.start(0)>30)return console.log("remove 2"),i.remove(0,i.buffered.end(0)-20),void(f.remStart=!1);m(d.currentTime,!0)}else d.cb()}catch(e){console.log("sourceBuffer error",e)}}));let m=(r,o)=>{if(!a)try{if(!o&&d.bussy)return void console.log("startSourceBuffer already loading");if(i.updating)return void console.log("loadChunks - sourceBuffer.updating");let l=null;if(null==r||null==f.from)l=0;else{if(!(i.buffered.length>0&&r>i.buffered.end(0)-20))return i.buffered.length>0&&r<i.buffered.start(0)?(console.log("startSourceBuffer rewind - reloading video"),a=!0,void e.reload()):void(d.bussy=!1);console.log("startSourceBuffer loading new chunks on to"),l=f.to}console.log("startSourceBuffer loading chunks");let u=0;d={finished:!1,bussy:!0,currentTime:null!=r?r:0},d.cb=(()=>{let e=l+f.chunkSize*u;if(e>=t)return console.log("stream end reached"),u=0,d.finished=!0,d.bussy=!1,void(d.cb=null);let r=e+f.chunkSize;r>=t&&(console.log("stream contentLength reached"),r=t),fetch(n+"&range="+e+"-"+(r-1)).then((e=>{e.arrayBuffer().then((e=>{console.log("startSourceBuffer appendBuffer");try{a||i.appendBuffer(e)}catch(e){console.log("appendBuffer error",e)}}).bind(this))}).bind(this)),u++,u>=f.chunkCnt&&(console.log("chunks loaded ",u,f.chunkCnt),u=0,d.finished=!0,d.cb=null)}).bind(d),f.from=l,f.to=l+f.chunkSize*f.chunkCnt,f.remStart=!0,f.remEnd=!0,d.cb()}catch(e){console.log("loadChunks error",e)}};return m(c),{currentTime:e=>{m(e)},stop:()=>{console.log("sourceBuffer stop"),a=!0}}}catch(e){throw console.log("MSE startSourceBuffer error: ",e),e}}let n=null,o=null,t=null;function l(u,c){if(u.video[u.quality].hasAudio)return console.log("audio and video"),void e(this,u,c,u.video[u.quality]);if(!window.MediaSource)return console.log("MediaSource not supported"),void e(this,u,c);let i=this,d=!1,s=new MediaSource;i.src=URL.createObjectURL(s);let a=()=>{d||(d=!0,console.log("reloading video",i.currentTime),null!=t&&clearInterval(t),i.pause(),l.bind(i)(u,i.currentTime))},f=!1,m=!1,g=()=>{f&&m&&(console.log("end of streams"),s.endOfStream())},h={reload:a,endOfStream:()=>{f=!0,g()}},v={reload:a,endOfStream:()=>{m=!0,g()}};s.addEventListener("sourceopen",(l=>{try{URL.revokeObjectURL(i.src);let e=u.video[u.quality];n=r(v,s,e.url,e.mimeType,e.contentLength,1e6,14,c),o=r(h,s,u.audio.url,u.audio.mimeType,u.audio.contentLength,1e5,14,c),running=!0,t=setInterval((()=>{console.log("current time",i.currentTime),i.duration>0&&(n.currentTime(i.currentTime),o.currentTime(i.currentTime))}),1e3),i.onerror=e=>{console.log("video error",e)};let l=!1;null!=c&&(i.currentTime=c);let d=()=>{4!=i.readyState||l?setTimeout(d,1e3):(console.log("play"),l=!0,i.play())};d()}catch(r){console.log("MSE error: ",l),i.src=null,null!=t&&clearInterval(t),e(i,u,c)}}))}window.YTMSEPlayer=function(e){return{play:l.bind(e),destroy:()=>{e.src=null,null!=n&&n.stop(),null!=o&&o.stop(),null!=t&&clearInterval(t)}}}}();